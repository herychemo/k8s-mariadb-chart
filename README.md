# mariadb
Simple MariaDB chart with replication support, for practice and reference purposes.

## Commands

### Install

```shell
# Install with default values.
helm upgrade --install gr-sample-app .
```

### Test

```shell
# Make sure to wait until all pods are running before.
kubectl get all

# Run tests
helm test gr-sample-app
```

The added test validate:
* Simple database service connection.
* Replication of sample data written in primary instance (0), to replica instances (1+).

## Architecture
The Statefulset generated by this Helm chart is expected to be consumed using
the one Write-Instance (primary) and multiple Read-Instances (replicas) pattern.

This pattern provides scalability to read-heavy systems with low writes.

## How to consume
This chart creates a headless service, perform your app writes using instance 0 (primary).
The read replicas (instances 1+) have eventual consistency.

### Sample configuration
For a 3 replicaCount setup (default for this chart), running in namespace 'quick-test'.

```shell
$ kubectl get all
NAME                                      READY   STATUS    RESTARTS   AGE
pod/gr-sample-app-mariadb-statefulset-0   1/1     Running   0          3m2s
pod/gr-sample-app-mariadb-statefulset-1   1/1     Running   0          2m55s
pod/gr-sample-app-mariadb-statefulset-2   1/1     Running   0          2m48s

NAME                                    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE
service/gr-sample-app-mariadb-service   ClusterIP   None         <none>        3306/TCP   3m2s

NAME                                                 READY   AGE
statefulset.apps/gr-sample-app-mariadb-statefulset   3/3     3m2s
```

Connect to instances using FQN:
```shell
# DB Host for writes, (0, primary).
gr-sample-app-mariadb-statefulset-0.gr-sample-app-mariadb-service.quick-test.svc.cluster.local

# DB hosts for reads (1+, replica).
gr-sample-app-mariadb-statefulset-1.gr-sample-app-mariadb-service.quick-test.svc.cluster.local
gr-sample-app-mariadb-statefulset-2.gr-sample-app-mariadb-service.quick-test.svc.cluster.local

# Where:
"$(STATEFULSET_NAME)-$(INSTANCE).$(SVC_NAME).$(NAMESPACE).svc.cluster.local"
```

### Notes
Notes file will print the FQN of primary and replica instances.

## Additional Notes:
This chart was created based on the following k8s statefulset repo:
* https://github.com/herychemo/k8s-mariadb-statefulset
